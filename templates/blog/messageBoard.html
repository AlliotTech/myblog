{% extends 'base-blog.html' %}
{% load static %}
{% block title %}ç•™è¨€æ¿{% endblock %}
{% block link %}
    <script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
{% endblock %}
{% block content %}
    <!--ä¸­é—´ä¸»ä½“éƒ¨åˆ†-->
    <main class="page-main">
        <div class="layui-row">
            <!--    é¡µé¢ä¸»ä½“éƒ¨åˆ†-->
            <div class="layui-col-md-offset2 layui-col-sm12 layui-col-md8 page-main-centre">
                <div class="layui-row main-centre">
                    <!--            ä¸»ä½“å·¦ä¾§éƒ¨åˆ†-->
                    <div class="layui-col-md9 main-left">
                        <div class="index-new message-board">
                            <div class="message-editor">
                                <div class="message-title clearfix">
                                    <div><h1>æˆ‘è¦ç•™è¨€</h1></div>
                                    <div><em>{{ count }}æ¡ç•™è¨€</em></div>
                                </div>
                                <hr class="layui-bg-gray">
                                <div class="layui-row message-body">
                                    <div class="layui-hide-xs layui-col-md1">
                                        <a>
                                            {% if userinfo.photo %}
                                                <img lay-src="/media/{{ userinfo.photo }}" class="layui-nav-img">
                                            {% else %}
                                                <img lay-src="/media/photo/default.png" class="layui-nav-img">
                                            {% endif %}
                                        </a>
                                    </div>
                                    <div class="layui-col-xs12 layui-col-md10">
                                        <textarea id="leave"></textarea>
                                    </div>
                                    <div class="layui-col-xs2 layui-col-md1">
                                        <button type="button" class="layui-btn layui-btn-normal">ç•™è¨€</button>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-tab">
                                <ul class="layui-tab-title">
                                    <li class="layui-this">å…¨éƒ¨ç•™è¨€</li>
                                    <li>çƒ­é—¨ç•™è¨€</li>
                                    <li>æˆ‘çš„ç•™è¨€</li>
                                </ul>
                                <div class="layui-tab-content">
                                    {#                                    æœ€æ–°ç•™è¨€#}
                                    <div class="layui-tab-item layui-show">
                                        {% for ol in all_message %}
                                            <ol class="list-body">
                                                {% for li in ol %}
                                                    <li class="reply-{{ li.level }} message-content">
                                                        <a href="#">
                                                            <img lay-src="../media/{{ li.photo }}"
                                                                 class="layui-nav-img">
                                                        </a>
                                                        <div class="text-box">
                                                            <div class="box-info">
                                                                {% if li.reply_name == 'None' %}
                                                                    <a href="#">{{ li.username }}</a>
                                                                {% else %}
                                                                    <a href="#">{{ li.username }}</a>
                                                                    <em>å›å¤</em>
                                                                    <a href="#">{{ li.reply_name }}</a>
                                                                {% endif %}
                                                                <span class="timeago" datetime="{{ li.time }}"></span>
                                                            </div>
                                                            <div class="box-body">
                                                                {{ li.content }}
                                                            </div>
                                                            <div class="box-action">
                                                                <a href="javascript:;" class="action-like"><i
                                                                        class="fas fa-thumbs-up"></i>èµ<em>{{ li.like }}</em></a>
                                                                <a href="javascript:;" class="action-reply"><i
                                                                        class="fas fa-comment-alt"></i>å›å¤</a>
                                                                {% if li.username == user.username %}
                                                                    <a href="javascript:;" class="action-delete"><i
                                                                            class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                {% else %}
                                                                    <a href="javascript:;"
                                                                       class="action-delete delete-no"><i
                                                                            class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ol>
                                        {% endfor %}
                                    </div>
                                    {#çƒ­é—¨ç•™è¨€#}
                                    <div class="layui-tab-item">
                                        <ol class="list-body">
                                            {% for i in hot_message %}
                                                <li class="message-content">
                                                    <a href="#">
                                                        <img src="/media/{{ i.user.userinfo.photo }}"
                                                             class="layui-nav-img">
                                                    </a>
                                                    <div class="text-box">
                                                        <div class="box-info">
                                                            <a href="#">{{ i.user.username }}</a>
                                                            <span class="timeago"
                                                                  datetime="{{ i.time|date:"Y-m-d H:i:s" }}"></span>
                                                        </div>
                                                        <div class="box-body">
                                                            {{ i.content }}
                                                        </div>
                                                        <div class="box-action">
                                                            <a href="javascript:;" class="action-like"><i
                                                                    class="fas fa-thumbs-up"></i>èµ<em>{{ i.like }}</em></a>
                                                            <a href="javascript:;" class="action-reply"><i
                                                                    class="fas fa-comment-alt"></i>å›å¤</a>
                                                            {% if i.user.username == user.username %}
                                                                <a href="javascript:;" class="action-delete"><i
                                                                        class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                            {% else %}
                                                                <a href="javascript:;"
                                                                   class="action-delete delete-no"><i
                                                                        class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ol>
                                    </div>
                                    {#                                        æˆ‘çš„ç•™è¨€#}
                                    <div class="layui-tab-item">
                                        {% if my_message %}
                                            <ol class="list-body">
                                                {% for i in my_message %}
                                                    <li class="message-content">
                                                        <a href="#">
                                                            <img src="/media/{{ i.user.userinfo.photo }}"
                                                                 class="layui-nav-img">
                                                        </a>
                                                        <div class="text-box">
                                                            <div class="box-info">
                                                                <a href="#">{{ i.user.username }}</a>
                                                                <span class="timeago"
                                                                      datetime="{{ i.time|date:"Y-m-d H:i:s" }}"></span>
                                                            </div>
                                                            <div class="box-body">
                                                                {{ i.content }}
                                                            </div>
                                                            <div class="box-action">
                                                                <a href="javascript:;" class="action-like"><i
                                                                        class="fas fa-thumbs-up"></i>èµ<em>{{ i.like }}</em></a>
                                                                <a href="javascript:;" class="action-reply"><i
                                                                        class="fas fa-comment-alt"></i>å›å¤</a>
                                                                {% if i.user.username == user.username %}
                                                                    <a href="javascript:;"
                                                                       class="action-delete"><i
                                                                            class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                {% else %}
                                                                    <a href="javascript:;"
                                                                       class="action-delete delete-no"><i
                                                                            class="fas fa-trash-alt"></i>åˆ é™¤</a>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                                {% else %}
                                                <h3>ğŸ¥ºæ‚¨è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥ç•™è¨€å§ï¼</h3>
                                            </ol>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% include 'blog/aside.html' %}
                    <!--            ä¸»ä½“å³ä¾§éƒ¨åˆ†-->
                </div>
            </div>
        </div>
        <div class=" " id="reply-div">
            <textarea id="reply" style="display: none;"></textarea>
        </div>
    </main>
{% endblock %}

{% block js %}
    <script>
        // å¯¼èˆªæ å½“å‰æ ‡ç­¾é¡µ
        $(".nav5").addClass("layui-this");
        layui.use(['form', 'layedit'], function () {
            var form = layui.form;
            var $ = layui.jquery;
            var layedit = layui.layedit;
            // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            form.render(); //æ›´æ–°å…¨éƒ¨
            // å›¾ç‰‡æ¥å£æ”¾åˆ°å»ºç«‹ç¼–è¾‘å™¨å‰é¢ï¼Œå¦åˆ™æ— æ•ˆ
            layedit.set({
                uploadImage: {
                    url: '{% url "account:commentUpload" %}', //æ¥å£url
                    type: 'post', //é»˜è®¤post
                }
            });
            // è®¾ç½®å‘è¡¨ç•™è¨€ç¼–è¾‘å™¨
            var index = layedit.build('leave', {
                height: 150 //è®¾ç½®ç¼–è¾‘å™¨é«˜åº¦
                , tool: ['face', 'image', '|', 'link', 'unlink']
            });
            // å»ºç«‹å‘è¡¨ç•™è¨€ç¼–è¾‘å™¨
            form.verify({ // è¿™é‡Œå°±æ˜¯æŠŠå¯Œæ–‡æœ¬æ•°æ®åŒæ­¥åˆ°<textarea>ä¸­
                content: function (value) {
                    return layedit.sync(index);
                }
            });
            // å‘è¡¨ç•™è¨€æŒ‰é’®äº‹ä»¶
            $(".message-body button").click(function () {
                var $content = layedit.getContent(index)
                if ($content.length == 0) {
                    layer.msg('äº²~è¯·å…ˆå‘è¡¨ç•™è¨€ï¼Œç„¶åå†æäº¤å“¦ï¼', {icon: 5})
                } else {
                    // æ–‡æœ¬åŸŸå†…å®¹éç©ºï¼Œåˆ›å»ºèŠ‚ç‚¹
                    var $record = createEle($content);
                    $(".layui-tab-item").prepend($record);
                    var timeago = layui.timeago;
                    timeago.render($('.timeago'));
                    layer.msg('æ„Ÿè°¢ç•™è¨€ï¼', {icon: 6})
                }
            })
            // ç•™è¨€ç‚¹èµ
            $("body").delegate(".action-like", "click", function () {
                var num = $(this).find("em").text();
                $(this).find("em").html(parseInt(num) + 1);
            })
            // ç•™è¨€åˆ é™¤
            $("body").delegate(".action-delete", "click", function () {
                $(this).parents(".list-body").remove();
            })
            // ç•™è¨€å›å¤
            $("body").delegate(".action-reply", "click", function () {
                layer.open({
                    type: 1
                    , title: 'å›å¤ç•™è¨€'
                    , area: ['400px', '300px']
                    , offset: 'auto'
                    , content: $('#reply-div').html()
                    , btn: ['å‘è¡¨å›å¤', 'å–æ¶ˆå›å¤']
                    , btnAlign: 'c'
                    , yes: function () {
                    }
                    , btn2: function () {
                        layer.closeAll();
                    },
                    success: function (layero, index) {
                        // è®¾ç½®å‘è¡¨ç•™è¨€ç¼–è¾‘å™¨
                        var index = layedit.build($(layero).find('#reply'), {
                            height: 150 //è®¾ç½®ç¼–è¾‘å™¨é«˜åº¦
                            , tool: ['face', 'image', '|', 'link', 'unlink']
                        });
                        // æŠŠå¯Œæ–‡æœ¬æ•°æ®åŒæ­¥åˆ°<textarea>ä¸­
                        form.verify({
                            content: function (value) {
                                return layedit.sync(index);
                            }
                        });
                    }
                });
            })

            // æ ¹æ®å†…å®¹åˆ›å»ºèŠ‚ç‚¹
            function createEle(content) {
                var $record = $('<ol class="list-body">\n' +
                    '            <li class="message-content">\n' +
                    '                <a href="#">\n' +
                    '                    <img src="/media/{{ userinfo.photo }}" class="layui-nav-img">\n' +
                    '                </a>\n' +
                    '                <div class="text-box">\n' +
                    '                    <div class="box-info">\n' +
                    '                        <a href="#">{{ user.username }}</a>\n' +
                    '                        <span class="timeago" datetime="{% now "Y-m-d H:i:s" %}"></span>\n' +
                    '                    </div>\n' +
                    '                    <div class="box-body">\n' + content +
                    '                    </div>\n' +
                    '                    <div class="box-action">\n' +
                    '                        <a href="javascript:;" class="action-like"><i class="fas fa-thumbs-up"></i>èµ<em>0</em></a>\n' +
                    '                        <a href="javascript:;" class="action-reply"><i class="fas fa-comment-alt"></i>å›å¤</a>\n' +
                    '                        <a href="javascript:;" class="action-delete"><i class="fas fa-trash-alt"></i>åˆ é™¤</a>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '            </li>\n' +
                    '        </ol>')
                return $record;
            }
        })
    </script>
{% endblock %}