{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
    <title>登录&注册</title>
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}"/>
    <link rel="stylesheet" href="{% static 'bootstrap-4.5.0/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
</head>
<body>
<div class="section">
    <div class="container">
        <div class="row full-height justify-content-center">
            <div class="col-12 text-center align-self-center">
                <div class="section pb-5 pt-sm-2 text-center">
                    <h3 class="mb-0 pb-3 change-title"><span>登录&nbsp;</span><span>&nbsp;注册</span></h3>
                    <input class="checkbox" type="checkbox" id="reg-log" name="reg-log"/>
                    <label for="reg-log"></label>
                    <div class="card-3d-wrap mx-auto">
                        <div class="card-3d-wrapper">
                            <div class="card-front">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="mb-4 pb-3">登&nbsp;录</h4>
                                        <form id="login" action="{% url 'account:loginRegister' %}" method="post">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                {{ login_form.user }}
                                                <i class="input-icon layui-icon layui-icon-username"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2">
                                                {{ login_form.password }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2 verification">
                                                <input id="id_reg_captcha_0" name="captcha_0" type="hidden"
                                                       value="{{ hashkey }}">
                                                <input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text"
                                                       class="form-style" placeholder="验证码">
                                                <a href="javascript:;" title="点击刷新验证码"><img src="{{ image_url }}"
                                                                                            alt="captcha"
                                                                                            class="captcha"></a>
                                                <i class="input-icon layui-icon layui-icon-vercode"></i>
                                                <p class="point"></p>
                                            </div>
                                            {% if message %}
                                                <h5 style="color: red">{{ message }}</h5>
                                            {% endif %}
                                            <button class="btn mt-4" type="button" id="login-btn"
                                                    onclick="login_check()">提交
                                            </button>
                                            <a href="{% url 'account:forgetPassword' %}"
                                               class="link forget">忘记密码?</a>
                                            <input name="type" type="hidden" value="登录">
                                        </form>
                                        <div>
                                            <h6 class="mb-0 mt-4 text-center">社交账号免注册登录</h6>
                                            <div class="layui-btn-group">
                                                <button type="button" class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-wechat"></i></button>
                                                <button type="button" class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-qq"></i></button>
                                                <button type="button" class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-weibo"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-back">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="pb-3">注&nbsp;册</h4>
                                        <form id="register">
                                            <div class="form-group" id="username">
                                                {{ register_form.username }}
                                                <i class="input-icon layui-icon layui-icon-username"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="email">
                                                {{ register_form.email }}
                                                <i class="input-icon layui-icon layui-icon-email"></i>
                                                <button type="button" class="layui-btn layui-btn-primary" id="send_btn">
                                                    获取验证码
                                                </button>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="email_code">
                                                {{ register_form.email_code }}
                                                <i class="input-icon layui-icon layui-icon-vercode"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="password1">
                                                {{ register_form.password1 }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="password2">
                                                {{ register_form.password2 }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                                <p class="point"></p>
                                            </div>
                                            <button id="register-btn" class="btn mt-4" type="button">注册</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'layui/layui.js' %}" charset="utf-8"></script>
<script src="{% static 'jquery-3.5.1/jquery-3.5.1.min.js' %}" charset="utf-8"></script>
<script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
<script>
    // 检查表单输入值是否为空
    function check_null(input) {
        $(input).each(function () {
            if ($(this).val().length == 0) {
                var point = "请输入" + $(this).attr("placeholder")
                $(this).siblings("p").text(point)
            } else {
                $(this).siblings("p").text("")
            }
            $(this).bind('input propertychange', function () {
                if ($(this).val().length == 0) {
                    var point = "请输入" + $(this).attr("placeholder")
                    $(this).siblings("p").text(point)
                } else {
                    $(this).siblings("p").text("")
                }
            })
        })
    }

    // 登录表单验证
    function login_check() {
        // 表单内容验证
        check_null("#login input")
        // 判断提示内容是否存在
        var point_length = 0
        $("#login .point").each(function () {
            point_length = point_length + ($(this).text()).length
        })
        if (point_length != 0) {
            return false;
        }
        $("#login").submit();
    }

    layui.use(['layer', 'form'], function () {
        var $ = layui.jquery,
            layer = layui.layer;
        // ajax加载动画
        var load
        $(document).on('ajaxStart', function () {
            load = layer.load();
        })
        $(document).on('ajaxComplete', function () {
            layer.close(load);
        })

        // 刷新验证码
        $('.captcha').click(function () {
            $.getJSON("/captcha/refresh/", function (result) {
                $('.captcha').attr('src', result['image_url']);
                $('#id_captcha_0').val(result['key'])
            });
        });

        // 用户名验证
        var name_timer = null;
        $("input[ name='username' ]").bind('input propertychange', function () {
            clearTimeout(name_timer);
            var username = $(this).val();
            if (parseInt(username.length) >= 3 && parseInt(username.length) <= 10) {
                name_timer = setTimeout(function () {
                    $.ajax({
                        type: "GET",
                        url: "{% url 'account:registerCheck' %}",
                        data: {username: username},
                        success: function (result) {
                            if (result.code == 1) {
                                $("input[ name='username' ]").siblings("p").text("");
                                $("input[ name='username' ]").css("border", "none");
                            } else {
                                $("input[ name='username' ]").siblings("p").text("用户名已存在");
                                $("input[ name='username' ]").css("border", "solid 1px red");
                            }
                        },
                        error: function (xhr) {
                            alert(xhr.text());
                        }
                    })
                }, 1500)
            } else {
                $(this).siblings("p").text("用户名长度为3到10位");
                $(this).css("border", "solid 1px red");
            }
        })

        // 邮箱验证
        var email_timer = null;
        $("input[ name='email' ]").bind('input propertychange', function () {
            clearTimeout(email_timer)
            var email = $(this).val();
            var enoughRegex = new RegExp("[\\w!#$%&'*+/=?^_`{|}~-]+(?:\\.[\\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\\w](?:[\\w-]*[\\w])?\\.)+[\\w](?:[\\w-]*[\\w])?", "g");
            if (enoughRegex.test(email) == false) {
                $(this).siblings("p").text("请输入正确的邮箱号");
                $(this).css("border", "solid 1px red");
            } else {
                $(this).siblings("p").text("");
                $(this).css("border", "none");
                email_timer = setTimeout(function () {
                    $.ajax({
                        type: "GET",
                        url: "{% url 'account:registerCheck' %}",
                        data: {email: email},
                        success: function (result) {
                            if (result.code == 1) {
                                $("input[ name='email' ]").siblings("p").text("");
                                $("input[ name='email' ]").css("border", "none")
                            } else {
                                $("input[ name='email' ]").siblings("p").text("此邮箱已注册");
                                $("input[ name='email' ]").css("border", "solid 1px red");
                            }
                        },
                        error: function (xhr) {
                            alert(xhr.text());
                        }
                    })
                }, 1500)
            }
        })
        // 发送邮件验证码
        $("#send_btn").click(function () {
            var email = $(this).siblings("input").val()
            if (email.length == 0) {
                layer.msg("请输入邮箱号", {icon: 2})
                return false;
            }
            if ($(".point").eq(1).text().length != 0) {
                layer.msg("请输入正确的邮箱号", {icon: 2})
                return false;
            }
            if ($("#send_btn").hasClass("layui-btn-disabled")) {
                layer.msg("验证码已发送，请稍后再试", {icon: 2})
                return false;
            }
            $.ajax({
                type: "GET",
                url: "{% url 'account:emailCode' %}",
                data: {email: email,
                    action:"注册新用户"},
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg(result.msg, {icon: 1});
                        $("#send_btn").addClass("layui-btn-disabled");     //控制按钮为禁用
                        var second = 60;
                        var intervalObj = setInterval(function () {
                            $("#send_btn").text("重新获取" + "(" + second + ")");
                            if (second == 0) {
                                $("#send_btn").text("获取验证码");
                                $("#send_btn").removeClass("layui-btn-disabled");//将按钮可用
                                /* 清除已设置的setInterval对象 */
                                clearInterval(intervalObj);
                            }
                            second--;
                        }, 1000);
                    } else {
                        layer.alert(result.msg, {icon: 2});
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
        });
        // 邮箱验证码非空验证
        $("input[ name='email_code' ]").bind('input propertychange', function () {
            var email_code = $(this).val();
            if (email_code.length == 0) {
                $(this).siblings("p").text("请输入邮件验证码");
                $(this).css("border", "solid 1px red");
            } else {
                $(this).siblings("p").text("");
                $(this).css("border", "none");
            }
        })
        // 密码1验证
        $("input[ name='password1' ]").bind('input propertychange', function () {
            var password1 = $("input[ name='password1' ]").val();
            var password2 = $("input[ name='password2' ]").val();
            var enoughRegex = new RegExp("^(?![a-zA-z]+$)(?!\\d+$)(?![!@#$%^&*]+$)[a-zA-Z\\d!@#$%^&*]{6,20}$", "g");
            if (enoughRegex.test(password1) == false) {
                $(this).siblings("p").text("密码为6到20位字母加数字组合");
                $(this).css("border", "solid 1px red");
            } else {
                $(this).siblings("p").text("");
                $(this).css("border", "none");
            }
        })
        // 密码2验证
        $("input[ name='password2' ]").bind('input propertychange', function () {
            var password1 = $("input[ name='password1' ]").val();
            var password2 = $("input[ name='password2' ]").val();
            var enoughRegex = new RegExp("^(?![a-zA-z]+$)(?!\\d+$)(?![!@#$%^&*]+$)[a-zA-Z\\d!@#$%^&*]{6,20}$", "g");
            if (enoughRegex.test(password2) == false) {
                $(this).siblings("p").text("密码为6到20位字母加数字组合");
                $(this).css("border", "solid 1px red");
            } else {
                if (password1 === password2) {
                    $(this).siblings("p").text("");
                    $(this).css("border", "none");
                    $(this).siblings("p").text("");
                    $(this).css("border", "none");
                } else {
                    $(this).siblings("p").text("密码不一致");
                }
            }
        })
        // 用户注册提交
        $("#register-btn").click(function (e) {
            e.preventDefault();
            // 非空验证
            $("#register input").each(function () {
                if ($(this).val().length == 0) {
                    var point = "请输入" + $(this).attr("placeholder")
                    $(this).siblings("p").text(point)
                }
            })
            // 判断提示内容是否存在
            var point_length = 0
            $(".point").each(function () {
                point_length = point_length + ($(this).text()).length
            })
            if (point_length == 0) {
                var username = $("input[ name='username' ]").val();
                var email = $("input[ name='email' ]").val();
                var email_code = $("input[ name='email_code' ]").val();
                var password1 = $("input[ name='password1' ]").val();
                var password2 = $("input[ name='password2' ]").val();
                $.ajax({
                    type: "POST",
                    url: "{% url 'account:loginRegister' %}",
                    data: {
                        username: username,
                        email: email,
                        email_code: email_code,
                        password1: password1,
                        password2: password2,
                        type: "注册",
                    },
                    success: function (result) {
                        if (result.code == 1) {
                            layer.msg(result.msg, {icon: 6});
                            setTimeout(function () {
                                window.location.href = "/";
                            }, 1000);
                        } else {
                            layer.alert(result.msg, {icon: 2});
                            $("input[ name='email_code' ]").val("");
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })
            } else {
                layer.alert("请确认表单填写内容", {icon: 2})
            }
        })
    });
</script>
</body>
</html>