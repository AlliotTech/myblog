{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
    <title>登录&注册</title>
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}"/>
    <link rel="stylesheet" href="{% static 'bootstrap-4.5.0/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
</head>
<body>
<div class="section">
    <div class="container">
        <div class="row full-height justify-content-center">
            <div class="col-12 text-center align-self-center">
                <div class="section pb-5 pt-sm-2 text-center">
                    <h6 class="mb-0 pb-3"><span>登录</span><span>注册</span></h6>
                    <input class="checkbox" type="checkbox" id="reg-log" name="reg-log"/>
                    <label for="reg-log"></label>
                    <div class="card-3d-wrap mx-auto">
                        <div class="card-3d-wrapper">
                            <div class="card-front">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="mb-4 pb-3">登&nbsp;录</h4>
                                        <form action="{% url 'account:loginRegister' %}" method="post">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                {{ login_form.user }}
                                                <i class="input-icon layui-icon layui-icon-username"></i>
                                            </div>
                                            <div class="form-group mt-2">
                                                {{ login_form.password }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                            </div>
                                            <div class="form-group mt-2 verification">
                                                <input id="id_reg_captcha_0" name="captcha_0" type="hidden"
                                                       value="{{ hashkey }}">
                                                <input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text"
                                                       class="form-style"
                                                       placeholder="验证码">
                                                <a href="javascript:;" title="点击刷新验证码"><img src="{{ image_url }}"
                                                                                            alt="captcha"
                                                                                            class="captcha"></a>
                                                <i class="input-icon layui-icon layui-icon-vercode"></i>
                                            </div>
                                            {% if message %}
                                                <h5 style="color: red">{{ message }}</h5>
                                            {% endif %}
                                            <input class="btn mt-4" type="submit" value="登录" name="type">
                                            <a class="forget" href="{% url 'account:forgetPassword' %}"
                                               class="link forget">忘记密码?</a>
                                        </form>
                                        <div>
                                            <h6 class="mb-0 mt-4 text-center">社交账号免注册登录</h6>
                                            <div class="layui-btn-group">
                                                <button type="button" class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-wechat"></i></button>
                                                <button type="button" class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-qq"></i></button>
                                                <button type="button" class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-weibo"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-back">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="pb-3">注&nbsp;册</h4>
                                        <form action="{% url 'account:loginRegister' %}" method="post">
                                            {% csrf_token %}
                                            <div class="form-group" id="username">
                                                {{ register_form.username }}
                                                <i class="input-icon layui-icon layui-icon-username"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="email">
                                                {{ register_form.email }}
                                                <i class="input-icon layui-icon layui-icon-email"></i>
                                                <button type="button" class="layui-btn layui-btn-primary" id="send_btn">
                                                    获取验证码
                                                </button>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="email_code">
                                                <input type="password" name="email_code" class="form-style"
                                                       placeholder="邮箱验证码" autocomplete="off" required
                                                       oninvalid="setCustomValidity('请输入验证码');"
                                                       oninput="setCustomValidity('');">
                                                <i class="input-icon layui-icon layui-icon-vercode"></i>
                                            </div>
                                            <div class="form-group mt-2" id="password1">
                                                {{ register_form.password1 }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="password2">
                                                {{ register_form.password2 }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                                <p class="point"></p>
                                            </div>
                                            <input id="register-btn" class="btn mt-4" type="submit" value="注册"
                                                   name="type">
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'layui/layui.js' %}" charset="utf-8"></script>
<script src="{% static 'jquery-3.5.1/jquery-3.5.1.min.js' %}" charset="utf-8"></script>
<script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
<script>
    layui.use(['layer', 'form'], function () {
        var $ = layui.jquery,
            layer = layui.layer;
        // 刷新验证码
        $('.captcha').click(function () {
            $.getJSON("/captcha/refresh/", function (result) {
                $('.captcha').attr('src', result['image_url']);
                $('#id_captcha_0').val(result['key'])
            });

        });
        // 用户名验证
        var name_timer = null;
        $("#username input").bind('input propertychange', function () {
            clearTimeout(name_timer);
            username = $(this).val();
            if (parseInt(username.length) >= 3 && parseInt(username.length) <= 10) {
                name_timer = setTimeout(function () {
                    $.ajax({
                        type: "GET",
                        url: "{% url 'account:registerCheck' %}",
                        data: {username: username},
                        success: function (result) {
                            if (result.code == 1) {
                                $("#username input").siblings("p").text("");
                                $("#username input").css("border", "none");
                            } else if (result.code == 0) {
                                $("#username input").siblings("p").text("用户名已存在");
                                $("#username input").css("border", "solid 1px red");
                            }
                        },
                        error: function (xhr) {
                            alert(xhr.text());
                        }
                    })
                }, 1500)
            } else {
                $("#username input").siblings("p").text("用户名长度为3到10位");
                $("#username input").css("border", "solid 1px red");
            }
        })
        // 邮箱验证
        var email_timer = null;
        $("#email input").bind('input propertychange', function () {
            clearTimeout(email_timer)
            email = $(this).val();
            var enoughRegex = new RegExp("[\\w!#$%&'*+/=?^_`{|}~-]+(?:\\.[\\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\\w](?:[\\w-]*[\\w])?\\.)+[\\w](?:[\\w-]*[\\w])?", "g");
            if (enoughRegex.test(email) == false) {
                $("#email input").siblings("p").text("请输入正确的邮箱号");
                $("#email input").css("border", "solid 1px red");
            } else {
                $("#email input").siblings("p").text("");
                $("#email input").css("border", "none");
                email_timer = setTimeout(function () {
                    $.ajax({
                        type: "GET",
                        url: "{% url 'account:registerCheck' %}",
                        data: {email: email},
                        success: function (result) {
                            if (result.code == 1) {
                                $("#email input").siblings("p").text("");
                                $("#email input").css("border", "none")
                            } else if (result.code == 0) {
                                $("#email input").siblings("p").text("此邮箱已注册");
                                $("#email input").css("border", "solid 1px red");
                            }
                        },
                        error: function (xhr) {
                            alert(xhr.text());
                        }
                    })
                }, 1500)
            }
        })
        // 发送邮件验证码
        $("#send_btn").click(function () {
            email = $(this).siblings("input").val()
            if (email.length == 0) {
                layer.msg("请输入邮箱号", {icon: 2})
            } else if ($(".point").eq(1).text().length != 0) {
                layer.msg("请输入正确的邮箱号", {icon: 2})
            } else {
                $.ajax({
                    type: "GET",
                    url: "{% url 'account:emailCode' %}",
                    data: {email: email},
                    success: function (result) {
                        if (result.code == 1) {
                            layer.msg(result.msg, {icon: 1});
                        }
                        else if (result.code == 0){
                            layer.alert(result.msg, {icon: 2});
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })
                $("#send_btn").addClass("layui-btn-disabled");     //控制按钮为禁用
                var second = 60;
                var intervalObj = setInterval(function () {
                    $("#send_btn").text("重新获取" + "(" + second + ")");
                    if (second == 0) {
                        $("#send_btn").text("获取验证码");
                        $("#send_btn").removeClass("layui-btn-disabled");//将按钮可用
                        /* 清除已设置的setInterval对象 */
                        clearInterval(intervalObj);
                    }
                    second--;
                }, 1500);
            }
        });
        // 密码1验证
        $("#password1 input").bind('input propertychange', function () {
            password1 = $("#password1 input").val();
            password2 = $("#password2 input").val();
            var enoughRegex = new RegExp("^(?![a-zA-z]+$)(?!\\d+$)(?![!@#$%^&*]+$)[a-zA-Z\\d!@#$%^&*]{6,20}$", "g");
            if (enoughRegex.test(password1) == false) {
                $("#password1 input").siblings("p").text("密码为6到20位字母加数字组合");
                $("#password1 input").css("border", "solid 1px red");
            } else {
                $("#password1 input").siblings("p").text("");
                $("#password1 input").css("border", "none");
            }
        })
        // 密码2验证
        $("#password2 input").bind('input propertychange', function () {
            password1 = $("#password1 input").val();
            password2 = $("#password2 input").val();
            var enoughRegex = new RegExp("^(?![a-zA-z]+$)(?!\\d+$)(?![!@#$%^&*]+$)[a-zA-Z\\d!@#$%^&*]{6,20}$", "g");
            if (enoughRegex.test(password2) == false) {
                $("#password2 input").siblings("p").text("密码为6到20位字母加数字组合");
                $("#password2 input").css("border", "solid 1px red");
            } else {
                if (password1 === password2) {
                    $("#password2 input").siblings("p").text("");
                    $("#password2 input").css("border", "none");
                    $("#password1 input").siblings("p").text("");
                    $("#password1 input").css("border", "none");
                } else {
                    $("#password2 input").siblings("p").text("密码不一致");
                }
            }
        })
        // 用户注册提交
        $("#register-btn").click(function (e) {
            e.preventDefault();
            // 判断提示内容是否存在
            var point_length = 0
            $(".point").each(function () {
                point_length = point_length + ($(this).text()).length
            })
            if (point_length == 0) {
                var username = $("#username input").val();
                var email = $("#email input").val();
                var email_code = $("#email_code input").val();
                var password = $("#password1 input").val();
                $.ajax({
                    type: "POST",
                    url: "{% url 'account:loginRegister' %}",
                    data: {
                        username: username,
                        email: email,
                        email_code: email_code,
                        password: password,
                        type: "注册",
                    },
                    success: function (result) {
                        if (result.code == 3) {
                            layer.alert(result.msg, {icon: 2});
                            $("#email_code input").val("");
                        } else if (result.code == 2) {
                            layer.alert(result.msg, {icon: 2});
                            $("#email_code input").val("");
                        } else {
                            layer.msg(result.msg, {icon: 6});
                            setTimeout(function () {
                                window.location.href = "/";
                            }, 1000);
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })
            } else {
                layer.alert("请确认表单填写内容", {icon: 2})
            }
        })
    });
</script>
</body>
</html>