{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
    <title>登录&注册</title>
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}"/>
    <link rel="stylesheet" href="{% static 'bootstrap-4.5.0/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
</head>
<body>
<div class="section">
    <div class="container">
        <div class="row full-height justify-content-center">
            <div class="col-12 text-center align-self-center">
                <div class="section pb-5 pt-sm-2 text-center">
                    <h3 class="mb-0 pb-3 change-title"><span>登录&nbsp;</span><span>&nbsp;注册</span></h3>
                    <input class="checkbox" type="checkbox" id="reg-log" name="reg-log"/>
                    <label for="reg-log"></label>
                    <div class="card-3d-wrap mx-auto">
                        <div class="card-3d-wrapper">
                            <div class="card-front">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="mb-4 pb-3">登&nbsp;录</h4>
                                        <form id="login" class="layui-form" action="{% url 'account:loginRegister' %}"
                                              method="post">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                {{ login_form.user }}
                                                <i class="input-icon layui-icon layui-icon-username"></i>
                                            </div>
                                            <div class="form-group mt-2">
                                                {{ login_form.password }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                            </div>
                                            <div class="form-group mt-2 verification">
                                                <input id="id_reg_captcha_0" name="captcha_0" type="hidden"
                                                       value="{{ hashkey }}">
                                                <input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text"
                                                       class="form-style" placeholder="验证码" lay-verify="required"
                                                       lay-reqtext="请输入验证码！">
                                                <a href="javascript:;" title="点击刷新验证码">
                                                    <img src="{{ image_url }}" alt="captcha" class="captcha"></a>
                                                <i class="input-icon layui-icon layui-icon-vercode"></i>
                                            </div>

                                            <input type="submit" name="type" value="登录" class="btn mt-4" lay-submit="">
                                        </form>
                                        <div>
                                            <h6 class="mb-0 mt-4 text-center">社交账号免注册登录</h6>
                                            <div class="layui-btn-group">
                                                <button type="button" class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-wechat"></i></button>
                                                <button type="button" class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-qq"></i></button>
                                                <button type="button" class="layui-btn layui-btn-normal"><i
                                                        class="layui-icon layui-icon-login-weibo"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-back">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="pb-3">注&nbsp;册</h4>
                                        <form id="register" class="layui-form">
                                            <div class="form-group" id="username">
                                                {{ register_form.username }}
                                                <i class="input-icon layui-icon layui-icon-username"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="email">
                                                {{ register_form.email }}
                                                <i class="input-icon layui-icon layui-icon-email"></i>
                                                <button type="button" class="layui-btn layui-btn-primary" id="send_btn">
                                                    获取验证码
                                                </button>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="email_code">
                                                {{ register_form.email_code }}
                                                <i class="input-icon layui-icon layui-icon-vercode"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="password1">
                                                {{ register_form.password1 }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                                <p class="point"></p>
                                            </div>
                                            <div class="form-group mt-2" id="password2">
                                                {{ register_form.password2 }}
                                                <i class="input-icon layui-icon layui-icon-password"></i>
                                                <p class="point"></p>
                                            </div>
                                            <button id="register-btn" type="button" class="btn mt-4" lay-submit=""
                                                    id="login-btn">注册
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'layui/layui.all.js' %}" charset="utf-8"></script>
<script src="{% static 'jquery-3.5.1/jquery-3.5.1.min.js' %}" charset="utf-8"></script>
<script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
<script>
    layui.use(['form', 'layedit', 'laydate'], function () {
        var form = layui.form
            , $ = layui.jquery
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate;

        //自定义验证规则
        form.verify({
            username: function (value) { //value：表单的值、item：表单的DOM对象
                if (value.length < 3 || value.length > 10) {
                    return '用户名长度3到10位！'
                }
                if (/^\d+\d+\d$/.test(value)) {
                    return '用户名不能全为数字！';
                }
                if (!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$").test(value)) {
                    return '用户名不能有特殊字符！';
                }
                if (/(^\_)|(\__)|(\_+$)/.test(value)) {
                    return '用户名首尾不能出现下划线\'_\'';
                }
            },
            password: [
                /^(?![a-zA-z]+$)(?!\d+$)(?![!@#$%^&*]+$)[a-zA-Z\d!@#$%^&*]{6,20}$/
                , '密码必须6到20位，数字加字母组合！'
            ],
            password_same: function () {
                var password1 = $("input[ name='password1' ]").val()
                var password2 = $("input[ name='password2' ]").val()
                if (password1 != password2) {
                    return '密码不一致！'
                }
            }
        });
        // 发送邮件验证码
        $("#send_btn").click(function () {
            var email = $(this).siblings("input").val()
            if (email.length == 0) {
                layer.msg("请输入邮箱号", {icon: 2})
                return false;
            }
            if ($(".point").eq(1).text().length != 0) {
                layer.msg("请输入正确的邮箱号", {icon: 2})
                return false;
            }
            if ($("#send_btn").hasClass("layui-btn-disabled")) {
                layer.msg("验证码已发送，请稍后再试", {icon: 2})
                return false;
            }
            $.ajax({
                type: "GET",
                url: "{% url 'account:emailCode' %}",
                data: {
                    email: email,
                    action: "注册新用户"
                },
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg(result.msg, {icon: 1});
                        $("#send_btn").addClass("layui-btn-disabled");     //控制按钮为禁用
                        var second = 60;
                        var intervalObj = setInterval(function () {
                            $("#send_btn").text("重新获取" + "(" + second + ")");
                            if (second == 0) {
                                $("#send_btn").text("获取验证码");
                                $("#send_btn").removeClass("layui-btn-disabled");//将按钮可用
                                /* 清除已设置的setInterval对象 */
                                clearInterval(intervalObj);
                            }
                            second--;
                        }, 1000);
                    } else {
                        layer.alert(result.msg, {icon: 2});
                    }
                },
                error: function (xhr) {
                    alert(xhr.text());
                }
            })
        });
    });
</script>
</body>
</html>