{% load static %}
<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
    <title>é‡ç½®å¯†ç </title>
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}"/>
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'css/forgetPassword.css' %}">
    <script src="{% static 'jquery-3.5.1/jquery-3.5.1.min.js' %}"></script>
    <script src="{% static 'jquery.easing/jquery.easing.min.js' %}"></script>
    <script src="{% static 'layui/layui.js' %}" charset="utf-8"></script>
    <script src="{% static 'js/csrf.js' %}" charset="utf-8"></script>
</head>
<body>
<div class="main">
    <!-- multistep form -->
    <form id="msform" action="{% url 'account:loginRegister' %}" method="post">
        <!-- progressbar -->
        <ul id="progressbar">
            <li class="active">èº«ä»½éªŒè¯</li>
            <li>è®¾ç½®æ–°å¯†ç </li>
            <li>é‡ç½®å®Œæˆ</li>
        </ul>
        <!-- fieldsets -->
        <fieldset>
            <h2 class="fs-title">èº«ä»½éªŒè¯</h2>
            <div class="form-group" id="email">
                {{ forget_form.email }}
                <i class="input-icon layui-icon layui-icon-email"></i>
                <p class="point"></p>
                <button type="button" class="layui-btn layui-btn-primary auth-btn" id="send_btn">è·å–éªŒè¯ç </button>
            </div>
            <div class="form-group mt-2 verification">
                {{ forget_form.email_code }}
                <p class="point"></p>
                <i class="input-icon layui-icon layui-icon-vercode"></i>
            </div>
            <input type="button" name="next" class="next action-button" id="email_check" value="ä¸‹ä¸€æ­¥"/>
        </fieldset>
        <fieldset>
            <h2 class="fs-title">è®¾ç½®æ–°å¯†ç </h2>
            <div class="form-group mt-2" id="password1">
                {{ forget_form.password1 }}
                <p class="point"></p>
                <i class="input-icon layui-icon layui-icon-password"></i>
            </div>
            <div class="form-group mt-2" id="password2">
                {{ forget_form.password2 }}
                <p class="point"></p>
                <i class="input-icon layui-icon layui-icon-password"></i>
            </div>
            <input type="button" name="previous" class="previous action-button" id="password_check_last" value="ä¸Šä¸€æ­¥"/>
            <input type="button" name="next" class="next action-button" id="password_check_next" value="ä¸‹ä¸€æ­¥"/>
        </fieldset>
        <fieldset>
            <h2 class="fs-title">é‡ç½®å®Œæˆ</h2>
            <p class="fs-content">ğŸ˜Š å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•!</p>
            <a href="{% url 'account:loginRegister' %}">
                <input type="submit" name="submit" class="submit action-button" value="ç™»å½•"/>
            </a>
        </fieldset>
    </form>
</div>

<script>

    layui.use(['layer', 'form'], function () {
        var $ = layui.jquery,
            layer = layui.layer;
        // ajax åŠ è½½åŠ¨ç”»
        var load
        $(document).on('ajaxStart', function () {
            load = layer.load();
        })
        $(document).on('ajaxComplete', function () {
            layer.close(load);
        })
        $(document).ready(function () {
            //jQuery time
            var current_fs, next_fs, previous_fs; //fieldsets
            var left, opacity, scale; //fieldset properties which we will animate
            var animating; //flag to prevent quick multi-click glitches
            // åˆ‡æ¢æ˜¾ç¤ºä¸‹ä¸€é¡µ
            function show_next(current_fs, next_fs) {
                if (animating) return false;
                animating = true;
                //ä¿®æ”¹è¿›åº¦æ­¥éª¤æ æ ·å¼
                $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");

                //æ˜¾ç¤ºä¸‹ä¸€é¡µå†…å®¹
                next_fs.show();
                //éšè—ä¸Šä¸€é¡µå†…å®¹
                current_fs.animate({opacity: 0}, {
                    step: function (now, mx) {
                        //as the opacity of current_fs reduces to 0 - stored in "now"
                        //1. scale current_fs down to 80%
                        scale = 1 - (1 - now) * 0.2;
                        //2. bring next_fs from the right(50%)
                        left = (now * 50) + "%";
                        //3. increase opacity of next_fs to 1 as it moves in
                        opacity = 1 - now;
                        current_fs.css({
                            'transform': 'scale(' + scale + ')',
                            'position': 'absolute',
                            'width': '100%'
                        });
                        next_fs.css({'left': left, 'opacity': opacity});
                    },
                    duration: 800,
                    complete: function () {
                        current_fs.hide();
                        animating = false;
                    },
                    //this comes from the custom easing plugin
                    easing: 'easeInOutBack'
                });
            }

            // åˆ‡æ¢æ˜¾ç¤ºä¸Šä¸€é¡µ
            function show_last(current_fs, previous_fs) {
                if (animating) return false;
                animating = true;
                //de-activate current step on progressbar
                $("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");
                //show the previous fieldset
                previous_fs.show();
                //hide the current fieldset with style
                current_fs.animate({opacity: 0}, {
                    step: function (now, mx) {
                        //as the opacity of current_fs reduces to 0 - stored in "now"
                        //1. scale previous_fs from 80% to 100%
                        scale = 0.8 + (1 - now) * 0.2;
                        //2. take current_fs to the right(50%) - from 0%
                        left = ((1 - now) * 50) + "%";
                        //3. increase opacity of previous_fs to 1 as it moves in
                        opacity = 1 - now;
                        current_fs.css({'left': left});
                        previous_fs.css({'transform': 'scale(' + scale + ')', 'opacity': opacity});
                    },
                    duration: 800,
                    complete: function () {
                        current_fs.hide();
                        animating = false;
                    },
                    //this comes from the custom easing plugin
                    easing: 'easeInOutBack'
                });
            }

            // åˆ¤æ–­é‚®ç®±æ ¼å¼æ˜¯å¦æ­£ç¡®
            var email_timer = null;
            $("input[ name='email']").bind('input propertychange', function () {
                var email = $("input[ name='email']").val()
                clearTimeout(email_timer)
                var enoughRegex = new RegExp("[\\w!#$%&'*+/=?^_`{|}~-]+(?:\\.[\\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\\w](?:[\\w-]*[\\w])?\\.)+[\\w](?:[\\w-]*[\\w])?", "g");
                if (enoughRegex.test(email) == false) {
                    $(this).siblings("p").text("è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±å·");
                    $(this).css("border", "solid 1px red");
                } else {
                    $(this).siblings("p").text("");
                    $(this).css("border", "none");
                    email_timer = setTimeout(function () {
                        $.ajax({
                            type: "GET",
                            url: "{% url 'account:registerCheck' %}",
                            data: {email: email},
                            success: function (result) {
                                if (result.code == 1) {
                                    $("input[ name='email']").siblings("p").text("æ­¤é‚®ç®±æœªç»‘å®šè´¦å·ï¼");
                                    $("input[ name='email']").css("border", "solid 1px red");
                                } else {
                                    $("input[ name='email']").siblings("p").text("");
                                    $("input[ name='email']").css("border", "none")
                                }
                            },
                            error: function (xhr) {
                                alert(xhr.text());
                            }
                        })
                    }, 1000)
                }
            })
            // è·å–éªŒè¯ç æŒ‰é’®
            $("#send_btn").click(function () {
                var email = $("input[ name='email']").val()
                if (email.length == 0) {
                    layer.msg("è¯·è¾“å…¥é‚®ç®±å·", {icon: 2})
                    return false;
                }
                if ($(this).siblings("p").text().length != 0) {
                    layer.msg("è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±å·", {icon: 2})
                    return false;
                }
                if ($("#send_btn").hasClass("layui-btn-disabled")) {
                    layer.msg("éªŒè¯ç å·²å‘é€ï¼Œè¯·ç¨åå†è¯•", {icon: 2})
                    return false;
                }
                $.ajax({
                    type: "GET",
                    url: "{% url 'account:emailCode' %}",
                    data: {email: email,
                        action: "é‡ç½®å¯†ç "},
                    success: function (result) {
                        if (result.code == 1) {
                            layer.msg(result.msg, {icon: 1});
                            $("#send_btn").addClass("layui-btn-disabled");     //æ§åˆ¶æŒ‰é’®ä¸ºç¦ç”¨
                            var second = 60;
                            var intervalObj = setInterval(function () {
                                $("#send_btn").text("é‡æ–°è·å–" + "(" + second + ")");
                                if (second == 0) {
                                    $("#send_btn").text("è·å–éªŒè¯ç ");
                                    $("#send_btn").removeClass("layui-btn-disabled");//å°†æŒ‰é’®å¯ç”¨
                                    /* æ¸…é™¤å·²è®¾ç½®çš„setIntervalå¯¹è±¡ */
                                    clearInterval(intervalObj);
                                }
                                second--;
                            }, 1000);
                        } else {
                            layer.alert(result.msg, {icon: 2});
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })
            })
            // ç‚¹å‡»é‚®ç®±éªŒè¯ä¸‹ä¸€æ­¥æŒ‰é’®
            $("#email_check").click(function () {
                var email = $("input[ name='email']").val()
                var email_code = $("input[ name='email_code']").val()
                if (email_code.length == 0) {
                    layer.msg("è¯·è¾“å…¥éªŒè¯ç ", {icon: 2});
                    return false;
                }
                if (($(".point").eq(0).text().length) != 0) {
                    layer.msg("è¯·æ£€æŸ¥é‚®ç®±å·", {icon: 2});
                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: "{% url 'account:checkEmailCode' %}",
                    data: {
                        email: email,
                        email_code: email_code
                    },
                    success: function (result) {
                        if (result.code == 1) {
                            current_fs = $("#email_check").parent();
                            next_fs = $("#email_check").parent().next();
                            show_next(current_fs, next_fs)
                        } else {
                            layer.alert(result.msg, {icon: 2});
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })
            })
            // ç‚¹å‡»å¯†ç éªŒè¯ä¸Šä¸€æ­¥æŒ‰é’®
            $("#password_check_last").click(function () {
                current_fs = $(this).parent();
                previous_fs = $(this).parent().prev();
                show_last(current_fs, previous_fs)
            })
            // å¯†ç 1éªŒè¯
            $("input[ name='password1']").bind('input propertychange', function () {
                var password1 = $(this).val();
                var enoughRegex = new RegExp("^(?![a-zA-z]+$)(?!\\d+$)(?![!@#$%^&*]+$)[a-zA-Z\\d!@#$%^&*]{6,20}$", "g");
                if (enoughRegex.test(password1) == false) {
                    $(this).siblings("p").text("å¯†ç ä¸º6åˆ°20ä½å­—æ¯åŠ æ•°å­—ç»„åˆ");
                    $(this).css("border", "solid 1px red");
                } else {
                    $(this).siblings("p").text("");
                    $(this).css("border", "none");
                }
            })
            // å¯†ç 2éªŒè¯
            $("input[ name='password2']").bind('input propertychange', function () {
                var password1 = $("input[ name='password1']").val();
                var password2 = $("input[ name='password2']").val();
                var enoughRegex = new RegExp("^(?![a-zA-z]+$)(?!\\d+$)(?![!@#$%^&*]+$)[a-zA-Z\\d!@#$%^&*]{6,20}$", "g");
                if (enoughRegex.test(password2) == false) {
                    $(this).siblings("p").text("å¯†ç ä¸º6åˆ°20ä½å­—æ¯åŠ æ•°å­—ç»„åˆ");
                    $(this).css("border", "solid 1px red");
                } else {
                    if (password1 === password2) {
                        $(this).siblings("p").text("");
                        $(this).css("border", "none");
                        $(this).siblings("p").text("");
                        $(this).css("border", "none");
                    } else {
                        $(this).siblings("p").text("å¯†ç ä¸ä¸€è‡´");
                    }
                }
            })
            // ç‚¹å‡»å¯†ç éªŒè¯ä¸‹ä¸€æ­¥æŒ‰é’®
            $("#password_check_next").click(function () {
                // æ•°æ®æ ¡éªŒ
                var password1 = $("input[ name='password1']").val()
                var password2 = $("input[ name='password2']").val()
                if (password1.length == 0 || password2.length == 0)
                {
                    layer.msg("æ–°å¯†ç ä¸èƒ½ä¸ºç©º", {icon: 2})
                    return false;
                }
                if (($(".point").eq(2).text().length) + ($(".point").eq(3).text().length) != 0) {
                    layer.msg("è¯·æ£€æŸ¥å¯†ç æ ¼å¼", {icon: 2})
                    return false;
                }
                // ajaxæäº¤é‡ç½®è¡¨å•
                var email = $("input[ name='email' ]").val();
                var email_code = $("input[ name='email_code' ]").val();
                var password1 = $("input[ name='password1' ]").val();
                var password2 = $("input[ name='password2' ]").val();
                $.ajax({
                    type: "POST",
                    url: "{% url 'account:forgetPassword' %}",
                    data: {
                        email: email,
                        email_code: email_code,
                        password1: password1,
                        password2: password2,
                    },
                    success: function (result) {
                        if (result.code == 1) {
                            current_fs = $("#password_check_next").parent();
                            next_fs = $("#password_check_next").parent().next();
                            show_next(current_fs, next_fs);
                        } else {
                            layer.alert(result.msg, {icon: 2});
                        }
                    },
                    error: function (xhr) {
                        alert(xhr.text());
                    }
                })

            })
            // é‡ç½®å®Œæˆç™»å½•æŒ‰é’®
            $(".submit").click(function () {
                window.location.href = "{% url 'account:loginRegister' %}"
            })
        })
    });
</script>
</body>
</html>